<!-- This file is used by the callee, connects and waits for a call, used name is callee_uid -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>My Rtcc Application: Presence </title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <script type="text/javascript" src="http://download.rtccloud.net/js/webappid/pocnickqualif/env/qualif/debug/true"></script>
<style type="text/css">
    body {
        font-family: Helvetica;
    }
    #video-container {
        width: 320px;
        height: 180px;
        border: 1px solid black;
        background: #0074bc;
        margin-top: 20px;
    }
    #error {
        border: 4px solid red;
        display: none;
        width: 50%;
        padding: 14px;
    }

    #error h1 {
        margin: 0;
    }
</style>
</head>
<body>
        <div class="container">
            <div class="row">
            <h1 style="text-align:center;">Welcome to Rtcc App Presence Example</h1>
            </div>
            <div class="row">


                <div class="well col-md-6 col-md-offset-1">

    <div id="error">
        <h1>An error occurred:</h1>
        <div id="error-content"></div>
    </div>
    <script type="text/javascript">

        if (window.location.protocol === 'file:') { alert('your project must be served from a webserver and not from the file system'); }
        // Here is the definition of the uid used by this user and the authentication url used in order to get a token
        var UID_USER,
            // If you are using our Java, Ruby or Node.js server-SDK uncomment the following line and replace the placeholder YOUR_AUTH_URL wuth your authentication client url
            // AUTH_URL = 'http://YOUR_AUTH_URL/gettoken?uid=',
            // If you are using our PHP server-SDK uncomment the following line and replace the placeholder YOUR_AUTH_URL wuth your authentication client url
            // AUTH_URL = 'http://YOUR_AUTH_URL/gettoken.php?uid=',

            realTimeClient = '',
            rtcc = {},
            script,
            // Define the optional parameters
            options = {
                displayName : 'Callee',
                debugLevel: '3',
                hap: 'qualif/3/'
            },
            //Intialize Rtcc Function
            initializeRtcc = function (token) {
                // Initialize the Main Object with App Identifier, Token, RtccType, options
                rtcc = new Rtcc('pocnickqualif', token, 'internal', options);

                // Get the Connection Handler callback when the JavaScript is connected to the real-time client

                var presenceIcons = {'0': '/imgs/offline.png', '7': '/imgs/away.png','8': '/imgs/busy.png', '15': '/imgs/online.png'};
                var rosterUids = ['charlie', 'thomas', 'alexander'];
                var rosterDisplayName = {'charlie': 'Charlie', 'thomas': 'Thomas', 'alexander': 'Alexander'};
                rtcc.onRosterRetrieved = function (roster){
                    var presence_html = '<ul  class="list-unstyled">';
                    for(var i = 0; i<roster.length; i++){
                        var iconImg = '<img  style="height:20px;" src="'+ presenceIcons[roster[i].presence]+'"/>';
                        presence_html += '<li id="presence_'+roster[i].uid+'">' + iconImg + rosterDisplayName[roster[i].uid] +'</li>';
                    }
                    document.getElementById('presence_container').innerHTML = presence_html + '</ul>';
                }

                rtcc.onPresenceUpdate = function (uids_updated){
                  for(var i = 0; i<uids_updated.length; i++){
                    var iconImg = '<img src="'+ presenceIcons[uids_updated[i].presence] +'"/>';
                    document.getElementById("presence_"+uids_updated[i].uid).innerHTML = iconImg + rosterDisplayName[uids_updated[i].uid]
                  }
                }
                rtcc.onBurstUpdate = function (data){
                    var presence_anser_str = "<h3>onBurstUpdate</h3><ul class='list-unstyled'>";
                    for(var i = 0; i<data.length; i++){
                        presence_anser_str += '<li>UID: ' + data[i].uid + ' PRESENCE VALUE:' + data[i].presence + '</li>';
                    }
                    document.getElementById('presence-answer').innerHTML = presence_anser_str + '</ul>';
                }

                rtcc.onConnectionHandler = function (message, code) {
                    if (window.console) { console.log('Connection Handler : ' + message + ' ' + code); }

                    if (message === 'presenceOkNewUser'){
                        var presence = 15;
                        rtcc.rosterAdd(rosterUids);
                        rtcc.getRoster();
                        rtcc.setMyPresence(presence);
                        document.getElementById('once_connected').style.display = "";
                    }
                    else if (message === 'presenceOkAlreadyRegistered'){
                       rtcc.getRoster();
                        document.getElementById('once_connected').style.display = "";

                    }

                    switch (message) {
                    case 'connectedRtccDriver':
                        realTimeClient = 'RtccDriver';
                        break;
                    case 'connectedWebRTC':
                        realTimeClient = 'WebRTC';
                        break;
                    case 'sipOk':
                        document.getElementById('connecting').style.display = "none";
                        document.getElementById('stat').innerHTML = 'You are now connected ' + realTimeClient;
                        break;
                    case 'loggedasotheruser':
                        // force connection, kick other logged users
                         getToken(UID_USER, function (token){
                            rtcc.setToken(token);
                            rtcc.authenticate(1);
                        });
                        break;
                    }
                };
                // This function permits to catch events comming from the call
                rtcc.onCallHandler = function (callObj, args) {
                    if (args.type === 'call' || args.type === 'webRTCcall'){
                        if (args.status === 'active') {
                            document.getElementById('call').innerHTML = 'Call active';
                        } else if (args.status === 'terminated') {
                            document.getElementById('call').innerHTML = 'Waiting for a call';
                        }
                    }
                };
                //Initialize connection between the real-time client and the browser
                rtcc.initialize();
            },
             getToken = function (uid, callback) {
                var xhr;
                if (window.XMLHttpRequest) { // code for IE7+, Firefox, Chrome, Opera, Safari
                    xhr = new XMLHttpRequest();
                } else { // code for IE6, IE5
                    xhr = new ActiveXObject('Microsoft.XMLHTTP');
                }
                xhr.onreadystatechange = function () {
                    var response = xhr.responseText,
                        responseJson,
                        token;
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        response = xhr.responseText;
                        try {
                            responseJson = JSON.parse(response);

                        } catch (e) {
                            document.getElementById('error-content').innerHTML = e.message + '<br />' + e.stack + '<br />Response: ' + response;
                            document.getElementById('error').style.display = 'block';
                        }
                        if (responseJson.error) {
                            document.getElementById('error-content').innerHTML = 'error code:' + responseJson.error + '<br />Description:' + responseJson.error_description;
                            document.getElementById('error').style.display = 'block';
                        } else {
                            token = responseJson.token;
                            if (typeof callback === "function"){
                                callback(token)
                            }else{
                                initializeRtcc(token);
                            }
                        }
                    } else if (xhr.readyState === 4 && xhr.status !== 200) {
                        response = xhr.responseText;
                        console.log(response);
                        document.getElementById('error-content').innerHTML = response;
                        document.getElementById('error').style.display = 'block';
                    }
                };
                xhr.open('GET', AUTH_URL + uid, true);
                xhr.send();
                //initializeRtcc(UID_USER);
            },
            setMyPresence = function (){
                var element = document.getElementById('presence_value');
                var value = element.options[element.selectedIndex].value;
                rtcc.setMyPresence(value);
            },
            getPresence = function (){
                var value = document.getElementById('get_presence').value.split(',');
                rtcc.getPresence(value);
            },
            init = function () {
                document.getElementById('start_btn').disabled = true;
                document.getElementById('connecting').innerHTML = 'Connecting...';
               var element = document.getElementById('currentUser')
                UID_USER = element.options[element.selectedIndex].value;
                element.disabled = true;
                getToken(UID_USER);
            },
            // Test if browser is IE10
            // Poll for jQuery to come into existence
            checkReady = function (callback) {
                if (window.jQuery) {
                    callback();
                } else {
                    window.setTimeout(function () { checkReady(callback); }, 100);
                }
            };
    </script>

  <div class="form-group">
    <label for="currentUser">User</label>

    <select class="form-control" id='currentUser'><option value='charlie'>Charlie</option><option value='thomas'>Thomas</option><option value='alexander'>Alexander</option></option></select>
  </div>


<input type="button" id="start_btn" class="btn btn-lg btn-primary" onclick="javascript:init();" value="Start"><br/>
 <hr/>

    <div id="once_connected" style="display:none;">

  <div class="form-group">
    <label for="currentUser">Set My Presence</label>
      <select class="form-control"  id='presence_value'>
            <option value="0">Hidden</option>
            <option value="7">Away</option>
            <option value="8">Busy</option>
            <option value="15">Online</option>
      </select>

  </div>
  <input type="button" value="Set"  class="btn"  onclick="javascript:setMyPresence();" />
  <br/>
  <br/>

  <div class="form-group">
    <label> Get Presence</label>
    <input class="form-control" type="text" placeholder='uid,uid,uid' id="get_presence" value="charlie,thomas"/>
  </div>
  <input type="button"  class="btn"  onclick="javascript:getPresence();" value="Get Presence">


        <br>
    </div>

    <h4 id="connecting"></h4>
    <h4 id="user_name"></h4>
    <h4 id="stat"></h4>

    </div>
    <div class="col-md-3 well col-md-offset-1">
        <h3>Roster</h3>
        <div id='presence_container'></div>
        <div id="presence-answer">
        </div>

        </div>
    </div>
</div>
 </body>
</html>